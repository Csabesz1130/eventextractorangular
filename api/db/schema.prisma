generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  events        Event[]
  suggestions   EventSuggestion[]
  connectors    Connector[]
  settings      UserSettings?

  @@index([email])
}

model UserSettings {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  timezone          String   @default("UTC")
  defaultReminder   Int      @default(30) // minutes
  autoApprove       Boolean  @default(false)
  confidenceMin     Float    @default(0.7)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Event {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  title           String
  description     String?
  start           DateTime
  end             DateTime?
  timezone        String    @default("UTC")
  location        String?

  attendees       String[]  @default([])
  reminders       Int[]     @default([30])
  recurrence      String?   // RRULE format

  // Calendar sync
  googleEventId   String?   @unique
  outlookEventId  String?   @unique
  appleEventId    String?   @unique

  // Metadata
  source          String?   // gmail, sms, manual, etc.
  rawText         String?   @db.Text
  confidence      Float?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, start])
  @@index([googleEventId])
}

model EventSuggestion {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  title           String
  description     String?
  start           DateTime?
  end             DateTime?
  timezone        String    @default("UTC")
  location        String?

  attendees       String[]  @default([])
  reminders       Int[]     @default([30])

  // AI extraction metadata
  confidence      Float
  rawText         String    @db.Text
  source          String    // gmail, sms, quick_add, etc.
  sourceMeta      Json?     // { messageId, url, etc }

  // Status
  status          SuggestionStatus @default(PENDING)
  approvedAt      DateTime?
  snoozedUntil    DateTime?
  eventId         String?   // If approved and created

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId, status])
  @@index([userId, createdAt])
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
  SNOOZED
}

model Connector {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider        ConnectorProvider
  email           String?   // For Gmail/Outlook
  phone           String?   // For SMS

  // OAuth tokens (encrypted in production!)
  accessToken     String?   @db.Text
  refreshToken    String?   @db.Text
  tokenExpiry     DateTime?

  // Settings
  enabled         Boolean   @default(true)
  pollInterval    Int       @default(300) // seconds
  lastPolled      DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, provider, email])
  @@index([userId, enabled])
}

enum ConnectorProvider {
  GMAIL
  GOOGLE_CALENDAR
  OUTLOOK
  APPLE_CALENDAR
  TWILIO_SMS
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String   // event.created, suggestion.approved, etc.
  entityType  String   // Event, EventSuggestion, etc.
  entityId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@index([entityType, entityId])
}

